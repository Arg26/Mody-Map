<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ModyMap - Integrated Campus Guide</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />

    <style>
        /* --- Global Styles --- */
        html, body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            height: 100%;
            overflow: hidden; /* Prevents scrolling on the body */
        }

        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh; /* Full viewport height */
        }

        /* --- Header Styling --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #385e3a;
            color: white;
            padding: 10px 20px;
            height: 60px;
            flex-shrink: 0; /* Prevents header from shrinking */
            box-sizing: border-box;
            z-index: 1001; /* Ensure header is above side panel */
        }
        .logo-area { flex: 1; display: flex; align-items: center; }
        .logo {
            width: 150px;
            height: auto;
            padding: 5px;
        }
        .title-area { flex: 2; text-align: center; }
        .title-area h1 { margin: 0; font-size: 30px; font-weight: bold; }
        .tollfree-area { 
            flex: 1; 
            text-align: right; 
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        /* --- Location Button Style --- */
        #location-btn {
            background: #fff;
            color: #385e3a;
            border: 1px solid #385e3a;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
            margin-left: 15px;
            line-height: 38px; /* Helps center the icon */
            transition: background-color 0.2s, color 0.2s;
        }
        #location-btn:hover {
            background: #f0f0f0;
        }
        #location-btn.active {
            background: #0078d7;
            color: white;
            border-color: #005fa3;
        }
        
        /* [ --- NEW --- ] Style for the new logout button */
        #logout-btn {
            margin-left: 10px; 
            background: #d93025; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            padding: 8px 12px; 
            cursor: pointer;
            font-weight: bold;
        }
        #logout-btn:hover {
            background: #b0261e;
        }

        /* --- Main Content Styling --- */
        .main-content {
            flex-grow: 1; /* Takes up remaining height */
            height: calc(100vh - 60px); /* Full height minus header */
            position: relative; /* For absolute positioning of panels */
            overflow: hidden; 
        }

        /* --- Left Panel Styling (Now an overlay) --- */
        .left-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 400px; /* Fixed width */
            max-width: 90%; /* For mobile */
            height: 100%; /* Full height of parent */
            display: flex;
            flex-direction: column;
            background-color: #e6e6e6;
            overflow-y: auto;
            z-index: 1000; /* On top of map, below header */
            box-shadow: 2px 0 5px rgba(0,0,0,0.2);
            transform: translateX(-100%); /* Hidden by default */
            transition: transform 0.3s ease-in-out; /* Slide animation */
        }

        .left-panel.visible {
            transform: translateX(0); /* Class to show panel */
        }

        .building-image-container {
            height: 200px;
            background-image: url('ModyBackground.jpg'); 
            background-size: cover;
            background-position: center;
            position: relative;
            border-bottom: 2px solid black;
            flex-shrink: 0;
        }

        /* --- Controls Section in Left Panel --- */
        .controls-container {
            padding: 15px;
            background-color: #dcdcdc;
            border-bottom: 2px solid #b0b0b0;
            position: relative; /* For the close button */
        }
        
        .controls { display: flex; flex-direction: column; gap: 10px; }
        .controls input {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }
        .controls button {
            padding: 10px 15px;
            background: #0078d7;
            color: white; border: none; cursor: pointer; border-radius: 4px;
        }
        .controls button:hover { background: #005fa3; }

        #route-container, #search-container { display: none; }

        /* --- Map Links/Directory Styling --- */
        .map-links { flex-grow: 1; }
        .link-item {
            background-color: #e9c878; color: black;
            padding: 15px 20px;
            font-size: 18px; font-weight: bold; text-transform: uppercase;
            border-bottom: 1px solid #c7a760;
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .link-item:hover { background-color: #f7e099; }
        .arrow { font-size: 24px; font-weight: normal; }

        /* --- Right Panel & Map Styling --- */
        .right-panel {
            width: 100%; 
            height: 100%; 
        }
        #map {
            width: 100%;
            height: 100%;
            background-color: #ddd; /* Placeholder color */
        }

        /* --- Info Panel Styling (Right side) --- */
        #info-panel {
            position: absolute;
            top: 0; right: 0;
            width: 300px; 
            max-width: 90%; /* For mobile */
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: -2px 0 5px rgba(0,0,0,0.2);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            padding: 20px; 
            box-sizing: border-box;
            overflow-y: auto;
        }
        #info-panel.visible { transform: translateX(0); }
        .close-btn {
            position: absolute;
            top: 10px; right: 15px;
            font-size: 24px; font-weight: bold; cursor: pointer;
        }

        /* --- Style for the panel image --- */
        .info-panel-image {
            width: 100%; /* Make the image fill the panel's width */
            height: auto; /* Maintain aspect ratio */
            border-radius: 4px; /* Optional: rounded corners */
            margin-bottom: 15px; /* Add space between image and text */
        }
        
        /* --- Styles for custom map buttons --- */
        .leaflet-control-sidebar-button {
            padding: 0; 
            font-weight: bold;
            text-decoration: none;
            color: #333;
            text-align: center;
            width: 34px; 
            height: 34px; 
            box-sizing: border-box; 
            line-height: 1;
            display: flex; 
            justify-content: center; 
            align-items: center; 
        }
        .leaflet-control-sidebar-button:hover {
            background-color: #f4f4f4;
        }
        .leaflet-control-sidebar-button + .leaflet-control-sidebar-button {
            border-top: 1px solid #ccc;
        }

        /* [NEW] Specific style for the route icon (marker emoji) */
        .route-icon {
            font-size: 20px; 
        }

        /* Specific style for the search icon (magnifying glass emoji) */
        .search-icon {
            font-size: 20px; 
        }

        /* Leaflet Control Box Styling */
        .leaflet-routing-container {
            background-color: rgba(255, 255, 255, 0.8) !important;
        }

    </style>
</head>
<body>
    
    <div id="app-container">
        <div class="header">
            <div class="logo-area">
                <img src="ModyLogo.jpg" alt="MODY University Logo" class="logo">
            </div>
            <div class="title-area">
                <h1>ModyMap</h1>
            </div>
            <div class="tollfree-area">
                Tollfree: 1800-419-9988
                <button id="location-btn" onclick="toggleLiveLocation()" title="Show My Location">‚åñ</button>
                
                <span id="auth-controls"></span>
                
            </div>
        </div>

        <div class="main-content">
            <div class="left-panel"> 
                <div class="building-image-container">
                </div>

                <div class="controls-container">
                    <span class="close-btn" onclick="closeSidebar()" title="Close Panel">&times;</span>
                    
                    <div id="route-container" class="controls">
                        <input type="text" id="start" placeholder="Start Location" list="places">
                        <input type="text" id="end" placeholder="End Location" list="places">
                        <button onclick="showRoute()">Show Route</button>
                        <datalist id="places"></datalist>
                    </div>

                    <div id="search-container" class="controls">
                        <input type="text" id="search-box" placeholder="Enter place name from directory..." list="places">
                        <button onclick="searchPlace('search-box')">Search</button>
                    </div>
                </div>
                
                <div class="map-links" id="map-links-directory">
                    </div>
            </div>

            <div class="right-panel">
                <div id="map"></div>
                <div id="info-panel">
                    <span class="close-btn" onclick="closePanel()">&times;</span>
                    <div id="info-content"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <script>
        // --- Global variable to hold location data ---
        let locations = [];
        
        // --- Map Layers ---
        var streetLayer = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        });

        var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19,
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, et al.'
        });

        // --- Map Initialization ---
        var map = L.map('map', {
            center: [27.801564, 75.036523], // Campus Center
            zoom: 16,
            layers: [streetLayer] // Default layer
        });

        // --- Layer Control ---
        var baseMaps = { "Street View": streetLayer, "Satellite View": satelliteLayer };
        L.control.layers(baseMaps).addTo(map);

        // --- Custom Control for Sidebar Toggle ---
        L.Control.SidebarToggle = L.Control.extend({
            options: {
                position: 'topleft'
            },

            onAdd: function (map) {
                var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                container.style.backgroundColor = 'white';
                container.style.display = 'flex';
                container.style.flexDirection = 'column'; // Stack buttons
        
                // [MODIFIED] Using a marker emoji (üìç) for Find Route
                this._routeButton = this._createButton('&#128205;', 'Find Route', container, () => openSidebar('route'), 'route-icon');
                
                // Using a magnifying glass emoji (üîç) for Search
                this._searchButton = this._createButton('&#128269;', 'Search Directory', container, () => openSidebar('search'), 'search-icon');
                
                // Stop map clicks from propagating
                L.DomEvent.disableClickPropagation(container);
                return container;
            },

            // Added className parameter to _createButton
            _createButton: function (content, title, container, fn, className = '') {
                var link = L.DomUtil.create('a', 'leaflet-control-sidebar-button', container);
                link.innerHTML = content;
                link.href = '#';
                link.title = title;
                if (className) {
                    L.DomUtil.addClass(link, className);
                }
                
                L.DomEvent.on(link, 'click', L.DomEvent.stop)
                        .on(link, 'click', fn, this);
                return link;
            }
        });

        // Add the new control to the map
        new L.Control.SidebarToggle().addTo(map);

        // --- Functions to control the new sidebar ---
        function openSidebar(view) {
            closePanel(); // Close right info panel
            toggleView(view); // Set the content (route/search)
            document.querySelector('.left-panel').classList.add('visible');
        }

        function closeSidebar() {
            document.querySelector('.left-panel').classList.remove('visible');
        }
        
        // --- Fetch data and initialize the application ---
        document.addEventListener('DOMContentLoaded', function() {
            
            // [ --- NEW --- ] Set up Login/Logout button
            setupAuthUI(); 

            fetch('ModyData.json') 
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok. Status: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    locations = data;
                    populateDatalist();
                    populateCategoryDirectory();
                })
                .catch(error => {
                    console.error('Error fetching location data:', error);
                    alert('Could not load location data. Please make sure ModyData.json is in the correct folder.');
                });
            
            toggleView('search');
        });

        // --- Populate Datalist for Search Autocomplete ---
        function populateDatalist() {
            const placesDatalist = document.getElementById('places');
            placesDatalist.innerHTML = ''; 
            
            const myLocationOption = document.createElement('option');
            myLocationOption.value = 'My Location';
            placesDatalist.appendChild(myLocationOption);

            locations.forEach(location => {
                const option = document.createElement('option');
                option.value = location.NAME.trim();
                placesDatalist.appendChild(option);
            });
        }
        
        // --- Populate Category Directory ---
        function populateCategoryDirectory() {
            const directoryContainer = document.getElementById('map-links-directory');
            directoryContainer.innerHTML = ''; 

            const categories = [...new Set(locations.map(loc => loc.CATEGORY))];
            categories.sort();

            categories.forEach(category => {
                const linkItem = document.createElement('div');
                linkItem.className = 'link-item';
                linkItem.innerHTML = `${category} <span class="arrow">‚Üí</span>`;
                linkItem.onclick = () => showCategoryOnMap(category);
                directoryContainer.appendChild(linkItem);
            });
        }

        // --- Global Map State Variables ---
        var routingControl = null;
        var searchMarker = null;
        var userLocationMarker = null; 
        var locationWatchId = null; 
        var categoryMarkersGroup = L.layerGroup().addTo(map);
        let lastRouteUpdateTime = 0; 

        // --- Define a WALKING router ---
        var walkingRouter = L.Routing.osrmv1({
            serviceUrl: 'https://router.project-osrm.org/route/v1',
            profile: 'walking'
        });

        // --- Global GPS Options ---
        const geolocationOptions = {
            enableHighAccuracy: true,
            maximumAge: 10000, 
            timeout: 20000       
        };

        // --- Toggle for live location marker ---
        function toggleLiveLocation() {
            const btn = document.getElementById('location-btn');
            
            if (locationWatchId) {
                clearMap(); 
            } else {
                clearMap(); 
                
                if (!navigator.geolocation) {
                    alert("Geolocation is not supported by your browser.");
                    return;
                }
                
                btn.innerHTML = '&times;'; 
                btn.title = 'Stop Tracking';
                btn.classList.add('active');

                locationWatchId = navigator.geolocation.watchPosition(
                    (position) => {
                        console.log("Live location fix:", position.coords);
                        const userLatLng = L.latLng(position.coords.latitude, position.coords.longitude);

                        if (!userLocationMarker) {
                            userLocationMarker = L.circleMarker(userLatLng, {
                                radius: 8, fillColor: "#1E90FF", color: "#000",
                                weight: 1, opacity: 1, fillOpacity: 0.8
                            }).addTo(map).bindPopup("Your Location");
                            map.setView(userLatLng, 18);
                        } else {
                            userLocationMarker.setLatLng(userLatLng);
                        }
                    },
                    (error) => {
                        console.error(`Error getting location: ${error.message}`);
                        alert(`Error getting your location: ${error.message}`);
                        clearMap(); 
                    },
                    geolocationOptions
                );
            }
        }

        // --- This function now just toggles panel content ---
        function toggleView(view) {
            const routeContainer = document.getElementById('route-container');
            const searchContainer = document.getElementById('search-container');
            const mapLinks = document.getElementById('map-links-directory');
            
            clearMap(); 

            if (view === 'route') {
                routeContainer.style.display = 'flex';
                searchContainer.style.display = 'none';
                mapLinks.style.display = 'none';
            } else if (view === 'search') {
                routeContainer.style.display = 'none';
                searchContainer.style.display = 'flex';
                mapLinks.style.display = 'block'; 
            }
        }

        // --- Search for a single place ---
        function searchPlace(inputId) {
            clearMap();
            const searchName = document.getElementById(inputId).value.trim();
            if (!searchName) {
                alert("Please enter a location to search for.");
                return;
            }

            const location = locations.find(loc => loc.NAME.trim().toLowerCase() === searchName.toLowerCase());

            if (location) {
                const latLng = [location.LATITUDE, location.LONGITUDE];
                searchMarker = L.marker(latLng).addTo(map)
                    .bindPopup(`<b>${location.NAME}</b>`)
                    .openPopup();
                
                map.setView(latLng, 18);

                const infoContent = document.getElementById('info-content');
                
                let imageHtml = '';
                if (location.IMAGE_URL && location.IMAGE_URL.trim() !== '') {
                    imageHtml = `<img src="${location.IMAGE_URL}" alt="Image of ${location.NAME}" class="info-panel-image">`;
                }

                // [ --- NEW --- ]
                // Dynamically create the contact info block based on login status
                let contactHtml = '';
                const isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true';

                if (isLoggedIn) {
                    // User is logged in. Show the contact details.
                    // **IMPORTANT**: You must add a "CONTACT" field to your ModyData.json for this to work.
                    // e.g., "CONTACT": "dept-head@modyuniversity.ac.in"
                    contactHtml = `<p><b>Contact:</b> ${location.CONTACT || 'No contact info available.'}</p>`;
                } else {
                    // User is not logged in. Show the login link.
                    contactHtml = `<p><b><a href="login.html" style="color: #0078d7; text-decoration: none; font-weight: bold;">Login for contact details</a></b></p>`;
                }
                // [ --- END NEW --- ]

                // Build the final HTML for the info panel
                infoContent.innerHTML = `
                    ${imageHtml}
                    <h2>${location.NAME}</h2>
                    <p><b>Category:</b> ${location.CATEGORY}</p>
                    <p><b>Description:</b> ${location.DESCRIPTION}</p>
                    <p><b>Timings:</b> ${location.TIMING}</p>
                    ${contactHtml}  `;
                
                document.getElementById('info-panel').classList.add('visible');

                closeSidebar(); 
            } else {
                alert("Could not find the location: " + searchName);
            }
        }
        
        // --- Show all markers for a category ---
        function showCategoryOnMap(categoryName) {
            clearMap();
            closeSidebar(); 
            
            const categoryLocations = locations.filter(loc => loc.CATEGORY === categoryName);

            if (categoryLocations.length === 0) return;

            categoryLocations.forEach(location => {
                const marker = L.marker([location.LATITUDE, location.LONGITUDE])
                    .bindPopup(`<b>${location.NAME.trim()}</b>`);
                categoryMarkersGroup.addLayer(marker);
            });

            map.fitBounds(categoryMarkersGroup.getBounds().pad(0.1));
        }
        
        function closePanel() {
            document.getElementById('info-panel').classList.remove('visible');
        }

        // --- Routing with Live Tracking ---
        function showRoute() {
            clearMap(); 
            let startName = document.getElementById('start').value.trim();
            let endName = document.getElementById('end').value.trim();

            if (!startName || !endName) {
                alert("Please enter both a start and end location!");
                return;
            }

            const endLocation = locations.find(loc => loc.NAME.trim().toLowerCase() === endName.toLowerCase());

            if (!endLocation) {
                alert("Invalid end location. Please select from the list.");
                return;
            }

            if (startName.toLowerCase() === 'my location') {
                if (navigator.geolocation) {

                    const btn = document.getElementById('location-btn');
                    btn.innerHTML = '&times;'; 
                    btn.title = 'Stop Tracking';
                    btn.classList.add('active');

                    locationWatchId = navigator.geolocation.watchPosition(
                        (position) => {
                            console.log("Routing location fix:", position.coords);
                            
                            const userLatLng = L.latLng(position.coords.latitude, position.coords.longitude);
                            const endLatLng = L.latLng(endLocation.LATITUDE, endLocation.LONGITUDE);
                            const now = Date.now(); 

                            // 1. ALWAYS Update the Blue Dot
                            if (!userLocationMarker) {
                                userLocationMarker = L.circleMarker(userLatLng, {
                                    radius: 8, fillColor: "#1E90FF", color: "#000",
                                    weight: 1, opacity: 1, fillOpacity: 0.8
                                }).addTo(map).bindPopup("Your Location");
                            } else {
                                userLocationMarker.setLatLng(userLatLng);
                            }

                            // 2. DEBOUNCE the Route Calculation (every 5 seconds)
                            if (!routingControl || (now - lastRouteUpdateTime > 5000)) {
                                console.log("Requesting new route from server...");
                                lastRouteUpdateTime = now; 

                                if (!routingControl) {
                                    routingControl = L.Routing.control({
                                        waypoints: [userLatLng, endLatLng],
                                        router: walkingRouter,
                                        routeWhileDragging: false, showAlternatives: false,
                                        addWaypoints: false, draggableWaypoints: false,
                                        fitSelectedRoutes: true
                                    }).addTo(map);
                                } else {
                                    routingControl.setWaypoints([userLatLng, endLatLng]);
                                }
                            }

                            // 3. ALWAYS Smart Pan
                            if (!map.getBounds().contains(userLatLng)) {
                                map.panTo(userLatLng);
                            }
                        },
                        (error) => { 
                            console.error(`Error getting location: ${error.message}`);
                            alert(`Error getting your location: ${error.message}\n\nThe map will try to reconnect.`); 
                        },
                        geolocationOptions
                    );
                } else {
                    alert("Geolocation is not supported by your browser.");
                }
            } else {
                // --- This runs if "My Location" is NOT the start point ---
                const startLocation = locations.find(loc => loc.NAME.trim().toLowerCase() === startName.toLowerCase());
                if (!startLocation) {
                    alert("Invalid start location. Please select from the list.");
                    return;
                }
                routingControl = L.Routing.control({
                    waypoints: [
                        L.latLng(startLocation.LATITUDE, startLocation.LONGITUDE),
                        L.latLng(endLocation.LATITUDE, endLocation.LONGITUDE)
                    ],
                    router: walkingRouter, 
                    routeWhileDragging: false, showAlternatives: false,
                    addWaypoints: false, draggableWaypoints: false,
                    fitSelectedRoutes: true
                }).addTo(map);
            }
            
            closeSidebar();
        }

        // --- Utility function to clear map state ---
        function clearMap() {
            if (locationWatchId) {
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
                console.log("Stopped location watch.");
            }

            const btn = document.getElementById('location-btn');
            btn.innerHTML = '‚åñ';
            btn.title = 'Show My Location';
            btn.classList.remove('active');

            if (routingControl) {
                map.removeControl(routingControl);
                routingControl = null;
            }
            if (searchMarker) {
                map.removeLayer(searchMarker);
                searchMarker = null;
            }
            if (userLocationMarker) {
                map.removeLayer(userLocationMarker);
                userLocationMarker = null;
            }
            categoryMarkersGroup.clearLayers();
            closePanel();
            closeSidebar(); 
        }

        // [ --- NEW --- ]
        // --- Functions for Login/Logout UI ---
        
        /**
         * Checks session storage and adds the "Logout" button if logged in.
         * This runs when the page first loads.
         */
        function setupAuthUI() {
            const authControls = document.getElementById('auth-controls');
            const isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true';

            if (isLoggedIn) {
                authControls.innerHTML = `<button id="logout-btn" onclick="logout()" title="Logout">Logout</button>`;
            } else {
                authControls.innerHTML = ''; // No button if not logged in
            }
        }

        /**
         * Clears the login status from session storage and reloads the page.
         */
        function logout() {
            sessionStorage.removeItem('isLoggedIn');
            alert('You have been logged out.');
            location.reload(); // Reload the page to update the UI
        }
        // [ --- END NEW --- ]

    </script>
</body>
</html>